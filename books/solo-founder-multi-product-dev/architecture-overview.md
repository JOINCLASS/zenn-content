---
title: "アーキテクチャ全体像 — 5プロダクトの統合設計"
---

## 全体アーキテクチャ図

5つのプロダクトは、WebとモバイルでフレームワークとBaaSを分けつつ、CI/CDやセキュリティツールは共通基盤として統一しています。

```
┌─────────────────────────────────────────────────────────────────┐
│                     JoinClass プロダクト群                        │
├─────────────────────────┬───────────────────────────────────────┤
│    Webプロダクト (Next.js)    │    モバイルプロダクト (Flutter)       │
│                         │                                       │
│  ┌─────────────┐        │  ┌─────────────┐                      │
│  │  ShareToku  │        │  │   MochiQ    │                      │
│  │  Next.js 16 │        │  │  Flutter    │                      │
│  │  Supabase   │        │  │  Firebase   │                      │
│  └─────────────┘        │  │  Gemini AI  │                      │
│                         │  └─────────────┘                      │
│  ┌─────────────┐        │                                       │
│  │  Focalize   │        │  ┌─────────────┐                      │
│  │  Next.js 14 │        │  │ 元気ボタン   │                      │
│  │  Supabase   │        │  │  Flutter    │                      │
│  │  Stripe     │        │  │  Firebase   │                      │
│  │  Gemini AI  │        │  └─────────────┘                      │
│  └─────────────┘        │                                       │
│                         │                                       │
│  ┌─────────────┐        │                                       │
│  │Skill Tracker│        │                                       │
│  │  Next.js 15 │        │                                       │
│  │  Static LP  │        │                                       │
│  └─────────────┘        │                                       │
├─────────────────────────┴───────────────────────────────────────┤
│                         共通基盤                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐   │
│  │ Supabase │ │ Firebase │ │ Vercel / │ │ GitHub Actions   │   │
│  │  (BaaS)  │ │  (BaaS)  │ │ お名前.com│ │ (CI/CD)         │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │ Stripe   │ │ Umami    │ │ Semgrep  │                        │
│  │ (決済)   │ │(Analytics)│ │ (SAST)   │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
```

この図で注目すべきは、**共通基盤のレイヤーが薄いこと**です。5プロダクトが同じマイクロサービス基盤を共有しているわけではありません。共有しているのは「同じサービスを使っている」というレベルであり、各プロダクトのデータベースやデプロイパイプラインは完全に独立しています。

## 共有インフラの設計方針

### Supabase — Webプロダクトのバックエンド

ShareTokuとFocalizeは、それぞれ独立したSupabaseプロジェクトを持っています。同じSupabaseインスタンスを共有していない理由は明確です。

1. **障害の分離**: 一方のプロジェクトでDBの負荷が上がっても、もう一方に影響しない
2. **セキュリティの分離**: Row Level Securityのポリシーがプロダクト間で干渉しない
3. **コスト管理の透明性**: プロダクトごとのコストが明確に分かる

Supabaseの無料枠は「プロジェクトごと」に適用されるため、プロダクトを分けることで無料枠を最大限に活用できるという実利もあります。

### Firebase — モバイルプロダクトのバックエンド

MochiQと元気ボタンも同様に、それぞれ独立したFirebaseプロジェクトです。Firebaseの場合、特にCloud Messagingの設定（APNs証明書、FCMトークン）がプロダクトごとに異なるため、プロジェクトの分離は自然な選択です。

### Vercel — SSRアプリのホスティング

FocalizeとShareTokuをVercelにデプロイしています。Vercelは1アカウントで複数プロジェクトを管理でき、プロジェクトごとに環境変数やドメインを設定できます。

Vercelを選んだ理由は、Next.jsとの統合が圧倒的に良いからです。`vercel.json` すら不要で、`git push` するだけでデプロイが完了します。Edge FunctionsやISRのキャッシュ制御も、Vercelが最も安定して動作します。

### GitHub Actions — CI/CDの統一

5プロダクト全てでGitHub Actionsを使用しています。各プロダクトのリポジトリにワークフローファイルを配置し、PR作成時とmainブランチへのpush時にパイプラインが実行されます。

ワークフローの内容はプロダクトごとに異なりますが、3ステージ構成という設計思想は統一しています。

```
Stage 1: 静的解析（型チェック、リンター、SAST）
    ↓
Stage 2: テスト（ユニットテスト、カバレッジ）
    ↓
Stage 3: デプロイ（mainブランチのみ）
```

この統一により、新しいプロダクトのCI/CDを構築する際、既存プロダクトのワークフローをテンプレートとしてコピー&調整するだけで済みます。

### Stripe — 決済の集約

Stripeを使っているのは現時点ではFocalizeのみですが、Stripeアカウントは会社単位で1つ管理しています。将来的にSkill Trackerでも課金機能を追加する場合、同じStripeアカウント内でプロダクトを分けることで、決済の管理画面を一元化できます。

### Umami — プライバシーファーストなアナリティクス

Google Analyticsではなく、セルフホスト型のUmamiを採用しています。理由は2つです。

1. **GDPR/個人情報保護法への対応**: Umamiはcookieを使用しないため、Cookie同意バナーが不要
2. **コスト**: セルフホストすれば無料。複数プロダクトのトラッキングを1つのインスタンスで管理可能

Flutterアプリ（MochiQ、元気ボタン）はFirebase Analyticsを使用しています。モバイルアプリではFirebase Analyticsの方がイベントトラッキングの粒度が細かく、クラッシュレポート（Crashlytics）との統合も容易です。

### Semgrep — セキュリティスキャン

静的アプリケーションセキュリティテスト（SAST）ツールとして、FocalizeのCIパイプラインにSemgrepを組み込んでいます。CASA Tier 2認証の要件でもありますが、認証とは無関係に、すべてのWebプロダクトにSASTスキャンを導入すべきです。

## プロダクトごとのアーキテクチャ特性

### Focalize — 最も複雑なプロダクト

Focalizeは5プロダクトの中で最もアーキテクチャが複雑です。以下の外部サービスと統合しています。

```
Focalize のインテグレーションマップ:

ユーザー
  ├── Google OAuth → Gmail API (送受信)
  │                → Calendar API (日程調整)
  ├── Supabase Auth (認証)
  ├── Stripe (決済)
  │    ├── Checkout Session (初回決済)
  │    ├── Customer Portal (プラン変更)
  │    └── Webhook (イベント受信)
  ├── Gemini AI (メール解析, フォローアップ提案)
  ├── nodemailer (メール送信)
  ├── web-push (ブラウザ通知)
  └── next-intl (日英切り替え)
```

この複雑さを1人で管理可能にしているのは、Next.jsのApp Routerが全てをRoute Handlersとして吸収しているからです。Stripe WebhookもGoogle OAuth CallbackもRoute Handlerとして実装できるため、別途APIサーバーを立てる必要がありません。

### 元気ボタン — シンプルだが独自の難しさ

元気ボタンはアーキテクチャ的にはシンプルですが、**プッシュ通知の信頼性**という独自の技術課題があります。

```
元気ボタンの通知フロー:

親が「今日も元気！」ボタンをタップ
  ↓
Firestoreにチェックインを記録
  ↓
Cloud Functions (トリガー) → FCM (プッシュ通知)
  ↓
子どものデバイスに通知が届く
```

「ボタンを押したのに通知が届かない」は、このアプリにとって致命的な障害です。iOSのバックグラウンド制限やAndroidのDoze Modeなど、モバイルOSの省電力機能が通知の到達率に影響するため、フォールグラウンド/バックグラウンドの両方で確実に通知が届く実装が求められます。

### MochiQ — AI統合のアーキテクチャ

MochiQのアーキテクチャ上の特徴は、Gemini AIとの統合です。クイズ生成はクライアントサイドからGemini APIを直接呼び出す構成にしています。

```
MochiQのAI統合:

ユーザー入力 (テーマ or カメラ撮影)
  ↓
Flutter側でプロンプト構築
  ↓
Gemini AI API (google_generative_ai)
  ↓
レスポンスをパースしてクイズオブジェクトに変換
  ↓
Firestoreに保存 (スペースドリピテションのスケジュール計算)
```

サーバーサイドを経由しない理由は、1人開発でAPIサーバーの運用コストを増やしたくないからです。APIキーはFlutterアプリにbundle（難読化済み）していますが、将来的にはFirebase Cloud Functionsを経由するプロキシ方式に移行する予定です。

## 「共有しない」という設計判断

5プロダクトのアーキテクチャで最も重要な設計判断は、**コンポーネントもインフラも共有しない**ことです。

### 共有しない理由

1. **プロダクトごとにデザインが異なる**: FocalizeはSaaS的なダッシュボードUI、元気ボタンは高齢者向けのシンプルなUI。共通化する意味がない
2. **依存関係の連鎖リスク**: 共有ライブラリを更新した際に5プロダクト全てへの影響を確認する工数は、1人では対応できない
3. **Next.jsのバージョンが異なる**: Focalizeは14系、ShareTokuは16系、Skill Trackerは15系。Reactのバージョンも18と19が混在している

### 共有する代わりに統一しているもの

- **設計パターン**: ディレクトリ構成、命名規則、エラーハンドリングの方針を統一
- **ツールチェーン**: Tailwind CSS、ヘッドレスUIライブラリ、テストフレームワークを統一
- **CI/CDの構成**: 3ステージ構成のGitHub Actionsワークフロー
- **セキュリティヘッダー**: next.config.mjsのセキュリティ設定テンプレート

この「ゆるい共通化」が、1人で5プロダクトを管理するための現実的な解です。完全な共通化は理想的に見えますが、そのメンテナンスコスト自体が1人では負担しきれません。

次の章では、バックエンドの要であるSupabaseとFirebaseの使い分けをさらに深掘りします。
